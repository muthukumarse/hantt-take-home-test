name: DevOps Exercise Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allows manual trigger for the full Build & Deploy
    inputs:
      confirm_deploy:
        description: 'Type "yes" to confirm deployment to AWS'
        required: true
        default: 'no'

env:
  AWS_REGION: us-east-1
  # Credentials must be set in repository secrets
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  # Phase 1: Validation (Runs on every push)
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.0

      - name: Terraform Init & Validate
        working-directory: terraform
        run: |
          terraform init -backend=false
          terraform validate

      - name: Setup Packer
        uses: hashicorp/setup-packer@v2
        with:
          version: 1.8.6

      - name: Packer Init & Validate
        working-directory: packer
        run: |
          packer init .
          packer validate -syntax-only aws-linux-nginx.pkr.hcl

      - name: Ansible Syntax Check
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible
          ansible-playbook ansible/playbook.yml --syntax-check

  # Phase 2: Build Golden Image (Runs only on main with manual confirmation)
  build-ami:
    needs: validate
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.confirm_deploy == 'yes'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Packer
        uses: hashicorp/setup-packer@v2
        with:
          version: 1.8.6

      - name: Initialize Packer
        working-directory: packer
        run: packer init .

      - name: Build AMI
        working-directory: packer
        run: packer build aws-linux-nginx.pkr.hcl

  # Phase 3: Infrastructure Deployment (Runs after AMI build)
  deploy-infra:
    needs: build-ami
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.0

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        # -auto-approve is used for automation. In production, consider a separate detailed plan & apply workflow.
        run: terraform apply -auto-approve
